.\"	$OpenBSD$
.\"
.\" Copyright (c) 2017--2019 Kristaps Dzonsons <kristaps@bsd.lv>
.\"
.\" Permission to use, copy, modify, and distribute this software for any
.\" purpose with or without fee is hereby granted, provided that the above
.\" copyright notice and this permission notice appear in all copies.
.\"
.\" THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
.\" WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
.\" MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
.\" ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
.\" WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
.\" ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
.\" OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
.\"
.Dd $Mdocdate$
.Dt ORT-C-SOURCE 1
.Os
.Sh NAME
.Nm ort-c-source
.Nd produce ort C API implementation
.Sh SYNOPSIS
.Nm ort-c-source
.Op Fl jJv
.Op Fl h Ar header[,header...]
.Op Fl I Ar djv
.Op Fl N Ar d
.Op Fl S Ar sharedir
.Op Ar config...
.Sh DESCRIPTION
The
.Nm
utility accepts
.Xr ort 5
.Ar config
files, defaulting to standard input,
and produces a C implementation of the API generated by
.Xr ort-c-header 1 .
Its arguments are as follows:
.Bl -tag -width Ds
.It Fl h Ar header[,header...]
Include the set of comma-separated header files
.Ar header .
These headers should be generated by
.Xr ort-c-header 1 .
.It Fl I Ar djv
Which headers are depended upon by
.Fl h
inclusion.
This may include
.Ar d
for database input declarations,
.Ar j
for JSON export declarations, and/or
.Pq Ar v
for data validators.
.It Fl j
Output JSON output implementation.
.It Fl J
Output JSON input implementation.
.It Fl v
Output data validator implementation.
.It Fl N Ar d
Disable production of output, which may currently only be
.Ar b
to suppresses the database input implementations.
.It Fl S Ar sharedir
Directory containing external source files used for compatibility.
The default is to use the install-time directory.
.El
.Pp
The complexity of
.Fl h
and
.Fl I
is to allow for multiple headers with multiple implementations.
For example, a header with the JSON API requires
.Fl I Ar j ,
but the implementation may not specify
.Fl j
itself, although it must include dependent headers for the JSON API.
.Pp
By default, the database input and data structures definitions are
output with a header file of
.Pa db.h .
.Pp
All C code produced by
.Nm
conforms with the
.Xr style 9
manual of
.Ox .
.Ss Hashing
The password hashing facility defined in
.Xr ort 5
is implemented differently on different systems.
On
.Ox ,
it uses the
.Xr crypt_newhash 3
and
.Xr crypt_checkpass 3
functionality.
On all other systems, it uses the traditional
.Xr crypt 3
with an MD5
.Pq Qq $1
setting.
The seed is generated using
.Xr random 3 ,
so the calling application should invoke
.Xr srandom 3 .
.Ss Portability
The code output by
.Nm
is currently not portable between systems.
This is due to code being generated that is available on the system where
.Nm
is executed, for example, whether
.Fn crypt_newhash
or
.Fn b64_ntop
are usable.
Future version of the system may have flags for generating portable code that
bundles in all non-portable functions.
.\" The following requests should be uncommented and used where appropriate.
.\" .Sh CONTEXT
.\" For section 9 functions only.
.\" .Sh RETURN VALUES
.\" For sections 2, 3, and 9 function return values only.
.\" .Sh ENVIRONMENT
.\" For sections 1, 6, 7, and 8 only.
.\" .Sh FILES
.Sh EXIT STATUS
.\" For sections 1, 6, and 8 only.
.Ex -std
.Sh EXAMPLES
In the simplest case, put all C sources and headers (for validation,
database routines, and JSON output) into one pair of files.
Let
.Pa foo.ort
be the configuration file.
.Bd -literal -offset indent
% ort-c-header -jv foo.ort > db.h
% ort-c-source -jv foo.ort > db.c
.Ed
.Pp
Breaking up into two header and source files: one for basic database
functions, the other for JSON output.
.Bd -literal -offset indent
% ort-c-header foo.ort > db.h
% ort-c-header -g JSON_H -j -Nbd foo.ort > json.h
% ort-c-source -h db.h > db.c
% ort-c-source -j -Nd -Idj -h db.h,json.h > json.c
.Ed
.Pp
In this more complicated snippet, the
.Pa json.h
file is created without structure or database information using
.Fl N , then
.Pa json.c
needs to include both database and JSON headers (in name,
.Fl h ,
and in the headers those stipulated in source,
.Fl I )
also while inhibiting database routine creation with
.Fl N .
.\" .Sh DIAGNOSTICS
.\" For sections 1, 4, 6, 7, 8, and 9 printf/stderr messages only.
.\" .Sh ERRORS
.\" For sections 2, 3, 4, and 9 errno settings only.
.Sh SEE ALSO
.Xr ort-c-header 1 ,
.Xr ort-c-manpage 1
.\" .Sh STANDARDS
.\" .Sh HISTORY
.\" .Sh AUTHORS
.\" .Sh CAVEATS
.\" .Sh BUGS
